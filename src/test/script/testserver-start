#/bin/sh
PIDFILE=$1
LOGFILE=$2
rake db:drop > /dev/null || {
	echo "Failed to drop database" 1>&2
	exit 1
}
echo "Database dropped!"
rake db:migrate > /dev/null || {
	echo "Failed to migrate database" 1>&2
	exit 1
}
echo "Database created"
rake db:populate:sample > /dev/null || {
	echo "Failed to populate database" 1>&2
	exit 1
}
echo "Database populated with samples"
rake "oauth2:client:create_with_id[GitHub Forge Publisher,http://forge.puppetlabs.com/,http://forge.puppetlabs.com/test/callback,,6ae715305e4c5fede6ee,89a983f88b7961df087cea1a8a8ee8255a7482bf]"
 > /dev/null || {
	echo "Failed to create OAuth2 client" 1>&2
	exit 1
}
echo "OAuth2 client added"
ruby script/server > $LOGFILE 2>&1 &
echo $! > "$PIDFILE"
sleep 3
echo "Forge Server Started. Logfile=$LOGFILE, Pidfile=$PIDFILE"
